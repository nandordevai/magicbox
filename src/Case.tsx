/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
Command: npx gltfjsx@6.5.3 src/assets/case.glb --types
*/

// Width min={40} max={120}
// Height min={20} max={50}
// Depth min={20} max={100}

import * as THREE from 'three'
import { useGLTF } from '@react-three/drei'
import { type GLTF } from 'three-stdlib'
import { useStore } from './store'
import { useEffect } from 'react'

type GLTFResult = GLTF & {
  nodes: {
    Scene: THREE.Group
    Case: THREE.Object3D
    Cube: THREE.Group
    Cube_1: THREE.Mesh
    Cube_2: THREE.Mesh
  }
  materials: {
    Material: THREE.MeshStandardMaterial
    Frame: THREE.MeshStandardMaterial
  }
}

export function Case() {
  const { current, color, min, max, syncMetadata } = useStore()
  const { nodes, materials } = useGLTF('/case.glb') as unknown as GLTFResult

  useEffect(() => {
    const meta = nodes.Case?.userData

    if (meta && (meta.minWidth || meta.maxWidth)) {
      syncMetadata(
        { width: meta.minWidth, height: meta.minHeight, depth: meta.minDepth },
        { width: meta.maxWidth, height: meta.maxHeight, depth: meta.maxDepth }
      )
    } else {
      console.error('metadata missing')
    }
  }, [nodes, syncMetadata])

  const getInf = (current: number, min: number, max: number) => {
    // prevent division by zero
    if (!max || !min || max === min) return 0

    const influence = (current - min) / (max - min)

    // clamp to 0 - 1
    const finalValue = Math.max(0, Math.min(1, influence))
    return isNaN(finalValue) ? 0 : finalValue
  }

  const influences = [
    getInf(current.width, min.width, max.width),
    getInf(current.height, min.height, max.height),
    getInf(current.depth, min.depth, max.depth),
  ]

  return (
    <group dispose={null}>
      <group name="Case">
        <mesh
          geometry={nodes.Cube_1.geometry}
          material={materials.Material}
          morphTargetInfluences={influences}
          castShadow
          frustumCulled={false}
        >
          <meshStandardMaterial
            map={materials.Material.map}
            color={color}
            roughness={materials.Material.roughness}
            metalness={materials.Material.metalness}
          />
        </mesh>
        <mesh
          geometry={nodes.Cube_2.geometry}
          material={materials.Frame}
          morphTargetInfluences={influences}
          castShadow
          frustumCulled={false}
        />
      </group>
    </group>
  )
}

useGLTF.preload('/case.glb')